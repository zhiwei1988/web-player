# WebSocket 流媒体播放器 - 快速验证Demo

## 📋 项目说明

这是一个10分钟快速验证Demo，用于测试WebSocket连接和数据接收功能。

**验证的功能模块：**
- ✅ WS-001: 支持 ws:// 协议连接
- ✅ WS-003: 支持二进制数据（ArrayBuffer）接收
- ✅ WS-005: 支持连接状态监控（连接中/已连接/断开/错误）
- ✅ WS-006: 实现数据接收缓冲队列（**新增**）
- ✅ WS-008: 提供连接统计信息（接收字节数、消息数、速率等）

## 🚀 快速开始（3步骤，约5分钟）

### 第1步：安装依赖（约1分钟）

```bash
npm install
```

### 第2步：启动WebSocket服务器（约30秒）

```bash
npm start
```

服务器将在 `ws://localhost:8080` 启动，并开始发送模拟音视频数据。

### 第3步：打开前端页面（约30秒）

在浏览器中直接打开 `index.html` 文件：

```bash
# 方法1：直接在浏览器中打开
open index.html  # macOS
xdg-open index.html  # Linux
start index.html  # Windows

# 方法2：使用Python启动HTTP服务器
python3 -m http.server 8000
# 然后访问 http://localhost:8000
```

### 第4步：测试连接（约2分钟）

1. 点击"🔌 连接"按钮
2. 观察连接状态变化
3. 查看控制台日志输出
4. 观察统计数据更新（接收字节数、消息数、速率等）

## 📊 预期验证结果

**成功指标：**
- ✅ 连接状态显示为"已连接"（绿色）
- ✅ 控制台显示接收到二进制数据日志
- ✅ 接收字节数持续增长（约10 KB/s）
- ✅ 接收消息数每秒增加1条
- ✅ 平均速率显示约10 KB/s
- ✅ 缓冲队列长度在 0-2 包之间波动
- ✅ 缓冲队列使用率保持在低水平（< 5%）
- ✅ 溢出次数保持为 0

**日志示例：**
```
✅ [08:30:15] 数据缓冲队列已初始化 (最大: 100包/10MB)
✅ [08:30:15] 数据消费者已启动 (每2秒消费1个数据包)
✅ [08:30:15] WebSocket 连接成功！
ℹ️ [08:30:16] 接收二进制数据: 10240 字节 (类型: ArrayBuffer) → 缓冲队列
ℹ️ [08:30:17] 接收二进制数据: 10240 字节 (类型: ArrayBuffer) → 缓冲队列
ℹ️ [08:30:18] 🔄 消费数据包: 10240 字节 (队列延迟: 1523ms)
ℹ️ [08:30:27] 接收文本数据: {"type":"metadata","frameInfo":{"type":"video"...
```

## 📁 项目文件结构

```
web_player/
├── index.html              # 前端验证页面（包含缓冲队列实现）
├── server.js               # WebSocket测试服务器
├── package.json            # Node.js项目配置
├── README.md               # 本说明文档
├── PRD_WebSocket_Media_Player.md   # 产品需求文档
└── WS-006_验证文档.md       # WS-006 缓冲队列功能验证文档
```

## 🛠️ 技术细节

### WebSocket服务器特性
- 监听端口：8080
- 数据发送间隔：1秒/次
- 每次数据块大小：10KB
- 数据类型：ArrayBuffer（模拟编码后的音视频数据）
- 心跳检测：30秒/次
- 支持多客户端连接

### 前端页面特性
- 实时连接状态显示
- 详细统计信息（字节数、消息数、连接时长、速率）
- **数据缓冲队列**（WS-006 实现）
  - 循环缓冲区（最大：100包 / 10MB）
  - FIFO（先进先出）策略
  - 自动溢出保护
  - 实时统计监控
  - 模拟消费者（每2秒消费1个数据包）
- 控制台日志（最近20条）
- Canvas元素（预留用于后续视频渲染）

## 🎯 后续开发建议

验证成功后，可以按照以下顺序继续开发：

1. **M1 - WebSocket连接增强**
   - [ ] 实现自动重连机制（WS-004）
   - [x] ~~实现数据接收缓冲队列（WS-006）~~ **已完成**
   - [ ] 完善心跳检测机制（WS-007）

2. **M2 - FFmpeg解码集成**
   - [ ] 集成 ffmpeg.wasm
   - [ ] 实现 H.264 视频解码
   - [ ] 实现 AAC 音频解码

3. **M3 - WebGL渲染**
   - [ ] 实现 YUV to RGB 色彩空间转换
   - [ ] 实现视频帧渲染

4. **M4 - 音频播放**
   - [ ] 使用 Web Audio API 播放音频
   - [ ] 实现音视频同步

## 🛑 停止服务器

### 方法1：前台运行（推荐）

如果服务器是在前台运行的（直接运行 `npm start`），只需在终端中按：

```bash
Ctrl + C
```

服务器会优雅地关闭所有连接并退出。

### 方法2：后台运行

如果服务器是在后台运行的，需要找到进程并终止：

```bash
# 查找占用8080端口的进程
lsof -i :8080  # macOS/Linux
# 或
netstat -ano | findstr :8080  # Windows

# 终止进程（替换 PID 为实际进程ID）
kill <PID>  # macOS/Linux
# 或
taskkill /PID <PID> /F  # Windows
```

或者直接通过端口终止：

```bash
# macOS/Linux
kill $(lsof -t -i:8080)

# Windows (需要管理员权限)
netstat -ano | findstr :8080
taskkill /PID <PID> /F
```

## ❓ 常见问题

**Q: 连接失败怎么办？**
A: 确保WebSocket服务器已启动（运行 `npm start`），并检查端口8080是否被占用。

**Q: 没有看到数据接收？**
A: 检查浏览器控制台是否有错误信息，确保WebSocket连接状态为"已连接"。

**Q: 如何修改服务器端口？**
A: 编辑 `server.js` 中的 `PORT` 常量，同时修改 `index.html` 中的默认连接地址。

**Q: 如何关闭WebSocket服务器？**
A: 如果服务器在前台运行，按 `Ctrl + C` 即可。如果在后台运行，使用 `lsof -i :8080` 查找进程ID，然后使用 `kill <PID>` 终止进程。

## 📝 开发日志

- **2026-01-02**: ✅ 实现 WS-006 数据接收缓冲队列功能
  - 添加 `DataBufferQueue` 循环缓冲队列类
  - 实现自动溢出保护机制
  - 添加详细的统计监控功能
  - 集成模拟数据消费者（用于测试）
  - 创建详细验证文档
- 2025-12-31: 创建快速验证Demo，实现基础WebSocket连接和数据接收功能

## 📄 许可证

MIT
