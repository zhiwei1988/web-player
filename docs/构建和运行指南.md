# 构建和运行指南

## 快速开始

```bash
# 1. 安装依赖
npm install

# 2. 编译 TypeScript
npm run build:ts

# 3. 启动服务器（Linux 服务器 192.168.50.101）
./bin/video_server &                # WebSocket 服务（8080 端口）
python3 -m http.server 8888         # HTTP 静态文件服务

# 4. 浏览器访问
# http://192.168.50.101:8888/index.html
```

## 项目结构

```
src/js/                    # TypeScript 源码
  ├── buffer/              # DataBufferQueue
  ├── stream/              # StreamInstance, StreamManager
  ├── ui/                  # StreamCard, GridLayout
  ├── decoder/             # WorkerBridge, DecoderWrapper
  └── worker/              # decode-worker

dist/js/js/                # 编译输出（npm run build:ts 生成）
index.html                 # 多流播放器
```

## 开发流程

### 1. 修改代码并编译

**自动编译模式（推荐）：**
```bash
npm run watch              # 监听文件变化，自动编译
```

**手动编译：**
```bash
npm run build:ts           # 编译 TypeScript
```

### 2. 刷新浏览器

按 `Ctrl+Shift+R` 强制刷新（清除缓存）

### 3. 查看日志

打开浏览器控制台（F12）查看：
- WebSocket 连接状态
- 解码器日志
- 错误信息

## 运行环境

### 服务器端（192.168.50.101）

```bash
# 启动 H.264 视频服务（默认）
./bin/video_server

# 启动 H.265 视频服务
CODEC_TYPE=h265 ./bin/video_server

# 启动 HTTP 服务
python3 -m http.server 8888
```

### 客户端（Mac 浏览器）

访问：
- `http://192.168.50.101:8888/index.html` - 多流版本

## 构建命令

```bash
npm run build:ts           # 编译 TypeScript（日常开发）
npm run build:wasm         # 编译 WASM 模块（修改 C 代码后）
npm run build:all          # 完整构建（首次或大改动后）
npm run clean              # 清理构建产物
npm run watch              # 监听模式
```

## 多流播放器使用

1. **添加流**：点击 "+ Add Stream"
2. **配置**：输入 WebSocket URL，选择编解码器
3. **连接**：点击 "Connect" 开始播放
4. **布局**：右上角切换网格模式（1x1/2x2/3x3/4x4）
5. **统计**：点击 "Statistics" 查看详细信息
6. **删除**：点击 "×" 或 "Disconnect"

## 常见问题

### TypeScript 编译失败
```bash
npm install                # 重新安装依赖
npm run build:ts           # 重新编译
```

### WASM 模块加载失败
- 确认 `dist/decoder.wasm` 存在
- 使用 HTTP 服务器（不要用 file:// 协议）

### WebSocket 连接失败
- 确认服务器运行：`ps aux | grep video_server`
- 确认 URL：`ws://192.168.50.101:8080`

### 视频无法解码
- 服务器和客户端编解码器类型要匹配
- H.264 服务器配 H.264 解码器
- H.265 服务器配 H.265 解码器

### 模块导入错误
确保通过 HTTP 服务访问，不要直接打开 HTML 文件。

## 开发技巧

### 查看编译输出
```bash
ls -la dist/js/js/         # 查看生成的文件
```

### 清理后重新构建
```bash
npm run clean
npm run build:ts
```

### 仅修改 WASM 代码
```bash
# 修改 src/wasm/decoder_wasm.c 后
npm run build:wasm
# 刷新浏览器
```

### 调试技巧
- 浏览器控制台查看日志
- Network 标签查看 WebSocket 连接
- Performance 标签分析性能
- 查看统计面板了解解码状态
